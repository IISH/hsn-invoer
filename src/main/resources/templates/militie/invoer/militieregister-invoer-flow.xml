<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">
  <!-- MS0I: IDENTIFICATIE NUMMER PERSOON MILITIE REGISTER -->
  <view-state id="MS0I" view="militie/MS0IC" model="akte">
    <on-entry>
      <evaluate expression="militieregisterService.createNewAkteForNewInput()" result="flowScope.akte"/>
    </on-entry>

    <transition on="stop" to="stopEnd"/>

    <transition on="next" to="MS0A">
      <evaluate expression="militieregisterService.registerOP(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MS0A: SCAN -->
  <view-state id="MS0A" view="militie/MS0A" model="akte">
    <transition on="stop" to="stopEnd"/>
    <transition on="next" to="determineScanSideB"/>
  </view-state>

  <action-state id="determineScanSideB">
    <evaluate expression="(akte.mil.scanB != '') and akte.isCropSideA()"/>

    <transition on="yes" to="MS0A">
      <evaluate expression="akte.setCropSideA(false)"/>
    </transition>

    <transition on="no" to="MS0B">
      <evaluate expression="akte.setCropSideA(false)"/>
    </transition>
  </action-state>

  <!-- MS0B: GEGEVENS REGISTER -->
  <view-state id="MS0B" view="militie/MS0B" model="akte">
    <transition on="stop" to="stopEnd"/>

    <transition on="next" to="MS1">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MS1: GEGEVENS LOTELING -->
  <view-state id="MS1" view="militie/MS1" model="akte">
    <transition on="stop" to="stopEnd"/>

    <transition on="next" to="MS2">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MS2: GEGEVENS OUDERS LOTELING -->
  <view-state id="MS2" view="militie/MS2" model="akte">
    <transition on="next" to="MS3">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MS3: LENGTE EN SIGNALEMENT -->
  <view-state id="MS3" view="militie/MS3" model="akte">
    <transition on="next" to="MS4">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MS4: MILITIE GEGEVENS LOTELING -->
  <view-state id="MS4" view="militie/MS4" model="akte">
    <transition on="next" to="includesExemptionCheck">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <action-state id="includesExemptionCheck">
    <evaluate expression="flowScope.akte.includesExemption == 'j'"/>

    <transition on="yes" to="MS5"/>
    <transition on="no" to="includesDelayCheck"/>
  </action-state>

  <!-- MS5: VRIJSTELLING -->
  <view-state id="MS5" view="militie/MS5" model="akte">
    <transition on="next" to="includesDelayCheck">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <action-state id="includesDelayCheck">
    <evaluate expression="flowScope.akte.includesDelay == 'j' or flowScope.akte.includesDelayMilition == 'j'"/>

    <transition on="yes" to="MS6a"/>
    <transition on="no" to="includesAppealCheck"/>
  </action-state>

  <!-- MS6a: UITSTEL -->
  <view-state id="MS6a" view="militie/MS6a" model="akte">
    <transition on="next" to="includesAppealCheck">
      <evaluate expression="militieregisterService.processVerdicts(flowScope.akte)"/>
    </transition>
  </view-state>

  <action-state id="includesAppealCheck">
    <evaluate expression="flowScope.akte.includesAppeal == 'j'"/>

    <transition on="yes" to="MS6b"/>
    <transition on="no" to="MS7"/>
  </action-state>

  <!-- MS6b: IN BEROEP -->
  <view-state id="MS6b" view="militie/MS6b" model="akte">
    <transition on="next" to="MS7">
      <evaluate expression="militieregisterService.processVerdicts(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MS7: AANSTELLING EN AANMERKINGEN -->
  <view-state id="MS7" view="militie/MS7" model="akte">
    <transition on="next" to="MSBYZ">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MSBYZ: BIJZONDERHEDEN -->
  <view-state id="MSBYZ" view="militie/MSBYZ" model="akte">
    <transition on="next" to="MSNIEUW">
      <evaluate expression="militieregisterService.saveMil(flowScope.akte)"/>
    </transition>
  </view-state>

  <!-- MSNIEUW: ANOTHER MILITIEREGISTER? -->
  <view-state id="MSNIEUW" view="militie/MSNIEUW" model="akte">
    <transition on="next" to="nieuwCheck"/>
  </view-state>

  <action-state id="nieuwCheck">
    <evaluate expression="requestParameters.anotherFlow == 'j'"/>

    <transition on="yes" to="MS0I"/>
    <transition on="no" to="finishEnd"/>
  </action-state>

  <end-state id="stopEnd" view="redirect:/militie/hoofdmenu">
    <on-entry>
      <evaluate expression="militieregisterService.deleteAkte(flowScope.akte)"/>
    </on-entry>
  </end-state>

  <end-state id="finishEnd" view="redirect:/militie/hoofdmenu"/>
</flow>